---

layout: ribbon

style: |

    #Cover h2 {
        margin:30px 0 0;
        color:#FFF;
        text-align:center;
        font-size:70px;
        }
    #Cover p {
        margin:10px 0 0;
        text-align:center;
        color:#FFF;
        font-style:italic;
        font-size:20px;
        }
        #Cover p a {
            color:#FFF;
            }
    #Picture h2 {
        color:#FFF;
        }
    #SeeMore h2 {
        font-size:100px
        }
    #SeeMore img {
        width:0.72em;
        height:0.72em;
        }
---

# Стоимость SPA-продудур {#Cover}

*Brought you by [Vadim Makeev](http://pepelsbey.net/) and generated by [Jekyller](https://github.com/shower/jekyller)*

![](pictures/cover.jpg)
<!-- photo by John Carey, fiftyfootshadows.net -->

## **Вам не нужны статьи<br/>"10 советов..."**

## **Вам нужны инструменты!**

## Без инструментов

* оптимизации нельзя увидеть
* не отследить влияние на реальных пользователей
* нельзя построить процесс и следить за состоянием приложения

// Очень важно, чтобы оптимизация не была единоразовой или от случая к случаю.
Над метриками скорости надо организовывать процесс.
Для начала хватит реалтаймовых графиков и тестирования каждого релиза на скорость.
Таким образом, мы останемся честными сами с собой и будем понимать, где именно мы медленные.
Налаженный процесс позволяет отслеживать релизы, в которых произошли изменения в скорости, а значит, мы точно сможем это исправить.
Даже если у вашей команды нет времени целенаправленно и постоянно заниматься оптимизацией, можно хотя бы следить за тем, чтобы не становилось хуже.

## part end

## Как отслеживать пользователя

Случайное генерируем ключ, который выдается при загрузке SPA и идентифицирует его сессию (session_id).

Его надо пробрасывать во всех запросах во все бекенды.

В каждый запрос еще можно добавлять ID(request_id).

## Зачем все это надо?!

1. Отличаем действия вкладки/браузера/устройства одного пользователя.
2. Легко отследить всю цепочку браузера->бекенд1->бекенд2->бекендN->БД.
3. Легко собрать всю сессию пользователя и понять что пошло не так.

## part end

## Проблемы локалки

1. Нечестное окружение
1. Влияние несжатого или нескомплированного кода (JIT, инлайниг)
1. В дев-окружении обычно больше логов
2. У вашего соседа будут другие результаты
3. Завтра вы не сможете повторить свой же результат

// У вас явно не тот почтовый ящик, что у среднего пользователя.
// На локалке или разработческом стенде все может работать по-другому. В дев-почте например есть динамическая локализации,
// а в проде статическая.
// Несжатый код влияет на JIT и инлайнинг. Поэтому результаты могут быть разные.
// Банально один и тот же тест может выполняться с очень большим разбросом по времени.
// У вас сегодня запущено много всего, завтра много другого, результаты всегда разные.

## Что нужно делать на локалке?

Нужно профилировать и искать проблемные места.

Но проверять эффективность оптимазации можно только на независимом стенде (или в продакшене на реальных логах).

## Методология

1. Собери **факты**
2. Проанализируйте и постройте теорию
3. Поменяйте **<mark>один!!!!</mark> участок кода**
4. Проверьте теорию

## part end

## **Как искать проблему?**

## **Профайлер вам не поможет!**

## Профайлер вам не поможет!

Профилировать запуск обновления SPA, в котором были сделаны десятки тысяч вызовов JS-функций немного сложновато...

Туда неизбежно попадут внутрении вызовы фреймворка, о которых вы ничего не знаете и не контроллируете.

А еще проблама в том, что сложно отследить к какому именно блоку относятся вызовы.

## Как искать проблему?

Вам помогут метрики стадий, чтобы узнать где большего всего потеряли время.
Фреймворки иногда имеют встроенные метрики производительности.

Надо проектировать сценарии в тестах так, чтобы избежать внешнего влияния.
Можно отключать какие-то виды и смотреть насколько ускоряется приложение.

// В больших SPA куча видов и на одной странице их может быть очень много.
// Поэтому важно проектировать тест, чтобы измерять скорость того вида, который вам нужен.
// Виды можно просто убирать со страницы или как-то отключать их от обновления

## Как искать проблему?

Не ленитесь и потратьте 10 минут времени на написание скрипта, который выполнит нужный вам сценарий действий.

Это сэкономит вам часы безтолкового кликанья по кнопкам и снятия метрик.

А еще даст возможность запускать этот сценари сколько угодно раз!

## part end

## Зачем нужен тестовый стенд?

1. Дает чистое окружение
2. Уменьшает внешнее воздействие
1. Оптимизации должны быть воспроизводимыми и стабильными. *Никакого разброса от 50 до 500мс.*{::}
1. Оптимизации должны появиться у реальных пользователей, а не у вас на локалке.
1. Надо много раз запускать один и тот же тест в разных браузерах

// Т.о. задача тестового стенда и тестировщиком максимально приблизиться к реальному окружению.

## Как сделать тестовый стенд

Берем два одинаковых сервера.

Один с прод-окружением, другой - с тестовым пакетом.

Запускаем одни и те же сценарии, сравниваем результаты.

// Очень важно иметь имеено две одинаковые машины, чтобы не делать скидки и поправки на разницу.

## part end

## Что нужно мерить

В идеале нужно уметь измерять любой сценарий пользователя "от клика до реакции SPA на это действие".

Для этого пригодится единый API "сделай что-то и перерисуй страницу".

// конкретная реализации зависит от фреймворка, но это всегда можно сделать
// единый API позволит вам контроллировать метрики в одном месте, а не расставлять их везде вручную

## Что нужно мерить

* подготовка к запросу на сервер (от действия пользователя до запроса)
* запрос данных с сервера
* шаблонизация
* обновление DOM
* обработка событий у view
* выполнение callback «после отрисовки»

## Что нужно мерить

Каждую стадию и общее время на измерять отдельно. Если общее время считать как сумму микро-метрик,
то вы рискуете потерять что-то важное.

Если общее время и сумма метрик не совпадает, значит у вас не считается какая-та стадия.

## part end

## Как мерить микрооптимизации

Иногда видно, что происходит тысячи вызовов микрофункции и это занимает главное время.

Как же померить ее скорость?

## Как мерить микрооптимизации

1. Проверить скорость разных варинтов реализации на [jsperf.com](http://jsperf.com/)
2. В своем приложении измеряем через [performance.now()](https://developer.mozilla.org/en-US/docs/Web/API/Performance/now)

## Как мерить микрооптимизации

    var sum = 0;

    function myFn() {
        var start = performance.now();
        callMicroFn();
        var end = performance.now();
        sum += (end - sum);


// Date.now не позволит вам измерить функции, который исполняются в районе 1ms
// Это можно сделать performance.now и т.о. посчитать сколько времени этот вызов занимает в вашем приложении

## part end

## Инструменты в популярных фреймворках

* [React Performance Tools](http://facebook.github.io/react/docs/perf.html)
* [Angular Batarang](https://github.com/angular/angularjs-batarang)

## Shower Key Features

1. Built on HTML, CSS and vanilla JavaScript
2. All modern browsers are supported
3. Slide themes are separated from engine
4. Fully keyboard accessible
5. Printable to PDF

{:.note}
Shower ['ʃəuə] noun. A person or thing that shows.


## Plain Text on Your Slides

Lorem ipsum dolor sit amet, consectetur [adipisicing](#all-kind-of-lists) elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, *quis nostrud* exercitation ullamco laboris **nisi ut aliquip** ex ea commodo consequat. Duis aute irure <i>dolor</i> in reprehenderit in voluptate velit esse cillum <b>dolore</b> eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in `<culpa>` qui officia deserunt mollit anim id est laborum.

## All Kind of Lists

1. Simple lists are marked with bullets
2. Ordered lists begin with a number
3. You can even nest lists one inside another
    - Or mix their types
    - But do not go too far
    - Otherwise audience will be bored
4. Look, seven rows exactly!

## Serious Citations

<figure markdown="1">

> Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia.

<figcaption>Marcus Tullius Cicero</figcaption>
</figure>

## Code Samples

    <!DOCTYPE html>
    <html lang="en">
    <mark><head></mark> <mark class="comment"><!--Comment--></mark>
        <title>Shower</title>
        <meta charset="<mark class="important">UTF-8</mark>">
        <link rel="stylesheet" href="screen.css">
    <mark></head></mark>

## Even Tables

|  Locavore      | Umami       | Helvetica | Vegan     |
+----------------|-------------|-----------|-----------+
|* Fingerstache *| Kale        | Chips     | Keytar    |
|* Sriracha     *| Gluten-free | Ennui     | Keffiyeh  |
|* Thundercats  *| Jean        | Shorts    | Biodiesel |
|* Terry        *| Richardson  | Swag      | Blog      |

It’s good to have information organized.

## Pictures
{:.cover #Picture}

![](pictures/picture.jpg)
<!-- photo by John Carey, fiftyfootshadows.net -->

## **You can even shout this way**

## Inner Navigation

1. Lets you reveal list items one by one
2. …To keep some key points
3. …In secret from audience
4. …But it will work only once
5. …Nobody wants to see the same joke twice

## ![](http://shwr.me/pictures/logo.svg) [See more on GitHub](https://github.com/shower/shower/)
{:.shout #SeeMore}
